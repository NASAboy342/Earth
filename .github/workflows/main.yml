name: Deploy to Server via API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy-via-api:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Call deployment API
      run: |
        echo "üöÄ Calling deployment API..."
        
        # Define the script file path (modify this as needed)
        SCRIPT_PATH="C:\deploy\test.ps1"
        
        # Call your API with the script file path (curl will handle URL encoding)
        response=$(curl -s -w "%{http_code}" -X GET \
          --data-urlencode "scriptFilePath=${SCRIPT_PATH}" \
          "https://apini.ppiinn.net/api/CicdController/release-earth-fe")
        
        http_code="${response: -3}"
        response_body="${response%???}"
        
        echo "Response Code: $http_code"
        echo "Response Body: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "‚úÖ Deployment API called successfully!"
          echo "üìù API Response: $response_body"
        else
          echo "‚ùå Deployment API failed with code: $http_code"
          echo "üìù Error Response: $response_body"
          exit 1
        fi
