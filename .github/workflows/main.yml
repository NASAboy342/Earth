name: Deploy to Server via API

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy-via-api:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Call deployment API
      run: |
        echo "ğŸš€ Calling deployment API..."
        
        # Define the script file path (modify this as needed)
        SCRIPT_PATH="C:\deploy\test.ps1"
        
        # Simple approach: use curl's -G flag with --data-urlencode for GET requests
        echo "ğŸ“ Script Path: $SCRIPT_PATH"
        
        # Call your API with the script file path (curl will handle URL encoding)
        response=$(curl -s -w "%{http_code}" -G \
          --data-urlencode "scriptFilePath=$SCRIPT_PATH" \
          "https://apini.ppiinn.net/api/CicdController/release-earth-fe")
        
        http_code="${response: -3}"
        response_body="${response%???}"
        
        echo "Response Code: $http_code"
        echo "Response Body: $response_body"
        
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… Deployment API called successfully!"
          echo "ğŸ“ API Response: $response_body"
        else
          echo "âŒ Deployment API failed with code: $http_code"
          echo "ğŸ“ Error Response: $response_body"
          exit 1
        fi
